<html>
<head>
	<title>imagetest</title>

<script src="javascript/imageTools2.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

	var t;

// mode, bits -> RST
function setTool() {
	var opts = {
		el: document.getElementById('fluke-img'),
		eventListeners: {
			mousemove: function(ev) {
				if (!t._mouseDown) return;
//console.log('(%d,%d)', ev.offsetX, ev.offsetY);
//console.log(ev);
ev.preventDefault();
				//note: never ever do translate with either rotate/scale. i.e. no odd numbers other than 1
				if (t._mode & 4) {
					var r = t.angleFromCenter(ev.offsetX, ev.offsetY) - t._startAngle;
				//if (r < 0) r += 360;
console.log('%.1f (%.3f)', r * (180/Math.PI), r);
					t.rotate(t._originalRotation + r);
				}
				if (t._mode & 2) {
					var c = t.getCenter();
					var d = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
					t.scale(d / t._startDist);// * t._originalScale);
				}
				if (t._mode & 1) {
					t.translate(ev.offsetX - t._mouseDown[0], ev.offsetY - t._mouseDown[1]);
				}
				if (!t._moved) clearCanvas();  //only on first move
				t._moved = true;
			},
/*
			mouseover: function(ev) {
				console.log('over!');
			},
*/
			mousedown: function(ev) {
				if (!t._mode) return;
				t._mouseDown = [ev.offsetX, ev.offsetY];
				t._startAngle = t.angleFromCenter(ev.offsetX, ev.offsetY);
				t._originalRotation = t.getRotation();
				var c = t.getCenter();
				t._startDist = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
				t._originalScale = t.getScale();
			},
			mouseup: function(ev) {
				if (!t._moved) {
					addSpot(ev.offsetX, ev.offsetY);
				}
				refreshCanvas();
				t._mouseDown = false;
				t._moved = false;
			},
/*
			mouseout: function(ev) {
				t._mouseDown = false;
				//t.rotate(t._originalRotation);
			},
*/
				
		}
	};



	t= new ImageTools(opts);
	t.spots = [];
	t._mode = 4;
//t.imageElement.addEventListener('mousemove', function() { console.log('mm'); }, false);
	console.info('created imageTools t');
}


function save() {
	$.ajax({
		url: 'SinglePhotoVideoTransform',
		type: 'POST',
		data: JSON.stringify({
			id: 'ff8081814f87d20f014f87d20f000000',
			name: 'foo.jpg',
			clientWidth: t.imageElement.width,
			transform: t.matrixToTransform(t.transform)
		}),
		complete: function(d) {
			if (d.responseJSON && d.responseJSON.success) {
				console.info('looks like it worked');
			} else if (d.responseJSON && d.responseJSON.error) {
				alert('ERROR saving: ' + d.responseJSON.error);
			} else {
				alert('ERROR ' + d.status + ' saving: ' + d.statusText);
			}
console.log('ok! %o', d);
		},
		dataType: 'json',
		contentType: 'application/json'
	});
}

var currentSpotType = null;
function addSpot(x,y,type) {
	if (!type) type = currentSpotType;
	t.spots.push([x, y, type]);
/*
	var s = t.matrixMultiply(t.transformInverse(), [x, y, 1]);
console.log('(%d,%d) -> (%d,%d)', x, y, s[0], s[1]);
	t.spots.push([s[0], s[1], type]);
*/
console.info('addSpots(%d,%d) -> %o', x, y, t.spots);
}


function refreshCanvas() {
	clearCanvas();
	drawSpots();
}

function clearCanvas() {
	t.ctx.clearRect(0, 0, t.canvasElement.width, t.canvasElement.height);
}
function drawSpots() {
	for (var i = 0 ; i < t.spots.length ; i++) {
//var m = t.computeTransformMatrix(2 * Math.PI - t.getRotation(), 1, 0, 0);
//var m = t.computeTransformMatrix(t.getRotation(), 1, 0, 0);
//var m = t.transformInverse();
var m = t.transform;
		var p = t.matrixMultiply(m, [t.spots[i][0] - 150, t.spots[i][1] - 150, 1]);
console.log('%d,%d -> %o', t.spots[i][0], t.spots[i][1], p);
		t.ctx.beginPath();
		t.ctx.arc(p[0] + 150, p[1] + 150, 20, 0, 2 * Math.PI);
		t.ctx.stroke();
	}
}


</script>

<style>
	#leaveMeAlone {
		position: relative;
		padding: 30px;
		margin: 40px;
		background-color: #CCC;
		height: 200px;
	}

	img#fluke-img {
		position: absolute;
		top: 30px;
		left: 100px;
		width: 300px;
	}

	.imageTools-containerElement {
		outline: solid 3px rgba(100, 255, 10, 0.8);
	}
</style>

</head>
<body>
hello!

<div id="leaveMeAlone">
	<img id="fluke-img" src="/shepherd_data_dir/encounters/1/d/1d29894f-50f4-47df-b444-a7619394aa28/test-pattern-mid.jpg" onLoad="setTool()" />
</div>

</body>
</html>
