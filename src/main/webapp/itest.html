<html>
<head>
	<title>imagetest</title>

<script src="javascript/imageTools2.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

	var t;
	var defaultCursor = 'crosshair';

	var spotStyle = {
		null: {
			strokeStyle: 'blue',
			fillStyle: 'rgba(0,0,0,0.4)'
		},
		tip: {
		},
		_ghost: {
			strokeStyle: 'black',
			fillStyle: 'rgba(255,255,255,0.7)',
			lineWidth: 3,
			setLineDash: [4,4]
		},
		_hilite: {
			strokeStyle: '#FCA',
			fillStyle: 'rgba(255,200,0,0.4)'
		}
	};

// mode, bits -> RST
function setTool() {
	var opts = {
		el: document.getElementById('fluke-img'),
		eventListeners: {
			contextmenu: function(ev) {
	console.log('menu!!!');
				t._addingSpot = false;
				ev.preventDefault();
				ev.stopPropagation();
			},

			mousemove: function(ev) {
				ev.preventDefault();

				//t._insideSpot refers to if mouse went *down* on a spot
				if (t._insideSpot > -1) {
					clearLabelCanvas();
					t.imageElement.style.cursor = 'grabbing';
					t.imageElement.style.cursor = '-moz-grabbing';
					t.imageElement.style.cursor = '-webkit-grabbing';
console.log('dragging spot %d', t._insideSpot);
					t._labelCanvasNeedsClearing = true;

					drawSpot(t.lctx, t.spots[t._insideSpot], '_ghost');
					drawSpot(t.lctx, [ev.offsetX, ev.offsetY], '_hilite');
					return;
				}

				var s = t.isNearSpot(ev.offsetX, ev.offsetY);
				if (s > -1) {
console.log(s);
					//t.imageElement.style.cursor = 'context-menu';
					t.imageElement.style.cursor = 'grab';
					t.imageElement.style.cursor = '-moz-grab';
					t.imageElement.style.cursor = '-webkit-grab';
				} else {
					t.imageElement.style.cursor = defaultCursor;
				}

				clearLabelCanvas();
				if (!t._mouseDown) return;
				t.imageElement.style.cursor = 'move';
//console.log('(%d,%d)', ev.offsetX, ev.offsetY);
//console.log(ev);
				//note: never ever do translate with either rotate/scale. i.e. no odd numbers other than 1
				if (t._mode & 4) {
					var r = t.angleFromCenter(ev.offsetX, ev.offsetY) - t._startAngle;
				//if (r < 0) r += 360;
console.log('%.1f (%.3f)', r * (180/Math.PI), r);
					t.rotate(t._originalRotation + r);
				}
				if (t._mode & 2) {
					var c = t.getCenter();
					var d = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
					t.scale(d / t._startDist);// * t._originalScale);
				}
				if (t._mode & 1) {
					t.translate(ev.offsetX - t._mouseDown[0], ev.offsetY - t._mouseDown[1]);
				}
				if (!t._moved) clearCanvas();  //only on first move
				t._moved = true;
			},
/*
			mouseover: function(ev) {
				console.log('over!');
			},
*/
			mousedown: function(ev) {
				t._addingSpot = false;
				t._insideSpot = t.isNearSpot(ev.offsetX, ev.offsetY);
if (t._insideSpot > -1) {
	console.log('spot=%d', t._insideSpot);
	return false;
}
				t._addingSpot = true;
				if (!t._mode) return;
				t._mouseDown = [ev.offsetX, ev.offsetY];
				t._startAngle = t.angleFromCenter(ev.offsetX, ev.offsetY);
				t._originalRotation = t.getRotation();
				var c = t.getCenter();
				t._startDist = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
				t._originalScale = t.getScale();
			},
			mouseup: function(ev) {
				t.imageElement.style.cursor = defaultCursor;

				if (t._insideSpot > -1) {
					var s = t.isNearSpot(ev.offsetX, ev.offsetY);
					if (s != t._insideSpot) {
						t.spots[t._insideSpot][0] = ev.offsetX;
						t.spots[t._insideSpot][1] = ev.offsetY;
					}
					clearLabelCanvas();
				}
				if (t._addingSpot && !t._moved) {
					addSpot(ev.offsetX, ev.offsetY);
				}
				refreshCanvas();
				t._addingSpot = false;
				t._insideSpot = -1;
				t._mouseDown = false;
				t._moved = false;
			},
/*
			mouseout: function(ev) {
				t._mouseDown = false;
				//t.rotate(t._originalRotation);
			},
*/
				
		}
	};



	t= new ImageTools(opts);
	t.spots = [];
	t._mode = 4;
//t.imageElement.addEventListener('mousemove', function() { console.log('mm'); }, false);
	console.info('created imageTools t');
}


function save() {
	$.ajax({
		url: 'SinglePhotoVideoTransform',
		type: 'POST',
		data: JSON.stringify({
			id: 'ff8081814f87d20f014f87d20f000000',
			name: 'foo.jpg',
			clientWidth: t.imageElement.width,
			transform: t.matrixToTransform(t.transform)
		}),
		complete: function(d) {
			if (d.responseJSON && d.responseJSON.success) {
				console.info('looks like it worked');
			} else if (d.responseJSON && d.responseJSON.error) {
				alert('ERROR saving: ' + d.responseJSON.error);
			} else {
				alert('ERROR ' + d.status + ' saving: ' + d.statusText);
			}
console.log('ok! %o', d);
		},
		dataType: 'json',
		contentType: 'application/json'
	});
}

var currentSpotType = null;
function addSpot(x,y,type) {
	if (!type) type = currentSpotType;
	t.spots.push([x, y, type]);
/*
	var s = t.matrixMultiply(t.transformInverse(), [x, y, 1]);
console.log('(%d,%d) -> (%d,%d)', x, y, s[0], s[1]);
	t.spots.push([s[0], s[1], type]);
*/
console.info('addSpots(%d,%d) -> %o', x, y, t.spots);
}


function refreshCanvas() {
	clearCanvas();
	drawSpots();
}

function clearCanvas() {
	t.ctx.clearRect(0, 0, t.canvasElement.width, t.canvasElement.height);
}

function clearLabelCanvas() {
	if (!t._labelCanvasNeedsClearing) return;
	t.lctx.clearRect(0, 0, t.labelCanvasElement.width, t.labelCanvasElement.height);
	t._labelCanvasNeedsClearing = false;
}

function drawSpots() {
	for (var i = 0 ; i < t.spots.length ; i++) {
/*
//var m = t.computeTransformMatrix(2 * Math.PI - t.getRotation(), 1, 0, 0);
//var m = t.computeTransformMatrix(t.getRotation(), 1, 0, 0);
//var m = t.transformInverse();
var m = t.transform;
		var p = t.matrixMultiply(m, [t.spots[i][0] - 150, t.spots[i][1] - 150, 1]);
console.log('%d,%d -> %o', t.spots[i][0], t.spots[i][1], p);
*/
		drawSpot(t.ctx, t.spots[i], t.spots[i][2]);
/*
		contextSetStyles(t.ctx, 
		t.ctx.beginPath();
		var p = t.toCanvasPoint(t.spots[i]);
		t.ctx.arc(p[0], p[1], 20, 0, 2 * Math.PI);
		t.ctx.fill();
		t.ctx.stroke();
*/
	}
}


function contextSetStyles(ctx, style) {
	if (!style) return;
	for (var s in style) {
		if (s == 'setLineDash') {
			ctx.setLineDash(style[s]);
		} else {
			ctx[s] = style[s];
		}
	}
}


function drawSpot(ctx, p, styleKey) {
	contextSetStyles(ctx, spotStyle[styleKey]);
	ctx.beginPath();
	var cp = t.toCanvasPoint(p);
	ctx.arc(cp[0], cp[1], 8, 0, 2 * Math.PI);
	ctx.fill();
	ctx.stroke();
}


</script>

<style>
	#leaveMeAlone {
		position: relative;
		padding: 30px;
		margin: 40px;
		background-color: #CCC;
		height: 200px;
	}

	img#fluke-img {
		position: absolute;
		top: 30px;
		left: 100px;
		width: 300px;
	}

	.imageTools-containerElement {
		xoutline: solid 3px rgba(100, 255, 10, 0.8);
	}
	.imageTools-imageElement {
	}
</style>

</head>
<body>
hello!

<div id="leaveMeAlone">
	<img id="fluke-img" src="/shepherd_data_dir/encounters/1/d/1d29894f-50f4-47df-b444-a7619394aa28/test-pattern-mid.jpg" onLoad="setTool()" />
</div>

</body>
</html>
