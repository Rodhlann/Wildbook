<html>
<head>
	<title>imagetest</title>

<script src="javascript/imageTools2.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

	var t;

// mode, bits -> RST
function setTool() {
	var opts = {
		el: document.getElementById('fluke-img'),
		eventListeners: {
			mousemove: function(ev) {
				if (!t._mouseDown) return;
//console.log('(%d,%d)', ev.offsetX, ev.offsetY);
//console.log(ev);
ev.preventDefault();
				//note: never ever do translate with either rotate/scale. i.e. no odd numbers other than 1
				if (t._mode & 4) {
					var r = t.angleFromCenter(ev.offsetX, ev.offsetY) - t._startAngle;
				//if (r < 0) r += 360;
console.log('%.1f (%.3f)', r * (180/Math.PI), r);
					t.rotate(t._originalRotation + r);
				}
				if (t._mode & 2) {
					var c = t.getCenter();
					var d = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
					t.scale(d / t._startDist);// * t._originalScale);
				}
				if (t._mode & 1) {
					t.translate(ev.offsetX - t._mouseDown[0], ev.offsetY - t._mouseDown[1]);
				}
			},
			click: function(ev) { console.warn('%o %o', ev.type, ev); },
/*
			mouseover: function(ev) {
				console.log('over!');
			},
*/
			mousedown: function(ev) {
				if (!t._mode) return;
				t._mouseDown = [ev.offsetX, ev.offsetY];
				t._startAngle = t.angleFromCenter(ev.offsetX, ev.offsetY);
				t._originalRotation = t.getRotation();
				var c = t.getCenter();
				t._startDist = t.dist(c[0], c[1], ev.offsetX, ev.offsetY);
				t._originalScale = t.getScale();
			},
			mouseup: function(ev) {
				t._mouseDown = false;
			},
/*
			mouseout: function(ev) {
				t._mouseDown = false;
				//t.rotate(t._originalRotation);
			},
*/
				
		}
	};


	t= new ImageTools(opts);
//t.imageElement.addEventListener('mousemove', function() { console.log('mm'); }, false);
	console.info('created imageTools t');
}


function save() {
	$.ajax({
		url: 'SinglePhotoVideoTransform',
		type: 'POST',
		data: JSON.stringify({
			id: 'ff8081814f877fca014f877fcaf90000',
			name: 'foo.jpg',
			clientWidth: t.imageElement.width,
			transform: t.matrixToTransform(t.transform)
		}),
		complete: function(d) {
console.log('ok! %o', d);
		},
		dataType: 'json',
		contentType: 'application/json'
	});
}

</script>

<style>
	#leaveMeAlone {
		position: relative;
		padding: 30px;
		margin: 40px;
		background-color: #CCC;
		height: 200px;
	}

	img#fluke-img {
		position: absolute;
		top: 30px;
		left: 100px;
		width: 300px;
	}

	.imageTools-containerElement {
		outline: solid 3px rgba(100, 255, 10, 0.8);
	}
</style>

</head>
<body>
hello!

<div id="leaveMeAlone">
	<img id="fluke-img" src="/shepherd_data_dir/encounters/b/1/b121d6ad-e776-4987-9607-f2993e197fc3/mid.jpg" onLoad="setTool()" />
</div>

</body>
</html>
